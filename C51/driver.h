#define "STC15.h"

#define D0 P04
#define D1 P05
#define D2 P06
#define D3 P07
#define DA P1

/*   
	**(0x80)**
	*        *
(0x40)      (0x20)
	*        *
	**(0x01)**
	*        *
(0x10)      (0x02)
	*        *
	**(0x08)**  (0x04)
*/

#define DOT 0x04
unsigned char code map[] = {
	/*0*/ 0x80 | 0x40 | 0x20 | 0x10 | 0x08 | 0x02,
	/*1*/ 0x20 | 0x02,
	/*2*/ 0x80 | 0x20 | 0x01 | 0x10 | 0x08,
	/*3*/ 0x80 | 0x20 | 0x01 | 0x02 | 0x08,
	/*4*/ 0x40 | 0x20 | 0x01 | 0x02,
	/*5*/ 0x80 | 0x40 | 0x01 | 0x02 | 0x08,
	/*6*/ 0x80 | 0x40 | 0x10 | 0x08 | 0x02 | 0x01,
	/*7*/ 0x80 | 0x20 | 0x02,
	/*8*/ 0x80 | 0x40 | 0x20 | 0x10 | 0x08 | 0x02 | 0x01,
	/*9*/ 0x80 | 0x40 | 0x20 | 0x08 | 0x02 | 0x01,
	/*A*/ 0x80 | 0x40 | 0x20 | 0x10 | 0x02 | 0x01,
	/*B*/ 0x40 | 0x10 | 0x08 | 0x02 | 0x01,
	/*C*/ 0x80 | 0x40 | 0x10 | 0x08,
	/*D*/ 0x20 | 0x10 | 0x08 | 0x02 | 0x01,
	/*E*/ 0x80 | 0x40 | 0x10 | 0x08 | 0x01,
	/*F*/ 0x80 | 0x40 | 0x10 | 0x01,
	/* */ 0x00
};

void driverInit() {
	/*24MHz*/
	AUXR |= 0x80;
	TMOD &= 0xF0;
	//TL0 = 0x40; TH0 = 0xA2; // 1ms
	TL0 = 0x90; TH0 = 0xE8; //250us
	TF0 = 0;
	TR0 = 1;
	ET0 = 1;
	EA = 1;
	
	P0M0 = 0; P0M1 = 0;
	P1M0 = 0; P1M1 = 0;
	
	DA = 0;
	D0 = 1; D1 = 1; D2 = 1; D3 = 1;
}

static char pos = 0;
static char value[] = { 16, 16, 16, 16 };
void timerInterrupt() interrupt 1 using 1 {
	switch (pos) {
		case 0:
			D1 = 1; D2 = 1; D3 = 1;
			DA = map[value[0]];
			D0 = 0;
			break;
		case 1:
			D0 = 1; D2 = 1; D3 = 1;
			DA = map[value[1]];
			D1 = 0;
			break;
		case 2:
			D0 = 1; D1 = 1; D3 = 1;
			DA = map[value[2]];
			D2 = 0;
			break;
		case 3:
			D0 = 1; D1 = 1; D2 = 1;
			DA = map[value[3]];
			D3 = 0;
			break;
	}
	pos = pos < 3 ? pos + 1 : 0;
}